name: "Checkout"
description: "Clones a fresh or updates an existing repo"
inputs:
  token:
    required: true
    description: "The Personal Access Token for accessing the repository"
runs:
  using: "composite"
  steps:
    - shell: bash
      run: |
        REPO_URL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY.git
        echo "Repo URL: $REPO_URL"
        echo Configuring GitHub credentials...
        echo "https://x-access-token:${{ inputs.token }}@github.com" > ~/.git-credentials
        if [ -d .git ]
        then
          echo Resetting...
          git rm --cached -r . || true  # necessary but may fail when no files
          git reset --hard HEAD
          git clean -df
          echo Fetching...
          git remote set-url origin $REPO_URL  # get rid of wrong credentials
          git fetch
        else
          echo Cloning...
          git clone $REPO_URL . \
            --no-checkout --depth 1
        fi
        echo Checking out ${{ github.sha }}...
        git checkout ${{ github.sha }}
        git submodule update --init --depth 1
        git status
